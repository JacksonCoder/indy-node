import pytest

from indy_node.server.plugin.agent_authz.commitment_db import CommitmentDb
from storage.test.conftest import parametrised_storage


comm1 = '1915182769368569486963976668657418846122016471585262452138689064979880063217142171230525667406114297912997697884669760718181148903891406258652154564474937314809392827351229074850339882653085906709452763512017926382658040877860425398565313118206001571983057266861433787870120516963262872556160137632986790799637800187327525373894833699998137974425675888510468704041321563743266953919273330110447213516904474856325884904918747921700098338253140217925656078220294833113261362981479227102302139442862538529417112227112104830922667359007109709204936925922862592053626140248383988977967399826184116697852122995719423774656923017777301713520425580745782097460248899329835740441429284020663186635354571333690692107185946297929772630086928323118606594588790915139339431940489511850279806818826143040378319619062305629273497273725721368157955512179352674013822087432127910233025333571203452180390613181846035364105352384024395662959142236311712295552933323767329374261596612060957502167831080774021620823718240397211269873903737841346862215246685242302847894894907938934985950908016181737929997451061016202494801606490097096889822976223609532834237496884730642312786447889763148272139117981855545441295507862786712405210727374768044118436617961'
comm2 = '3081076980007713925959604505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'
comm3 = '5579272769368569486959604505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'
comm4 = '450599352837009125203721943257004505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'
comm5 = '610599352837009125203721943257004505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'
comm6 = '710599352837009125203721943257004505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'
comm7 = '810599352837009125203721943257004505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'
comm8 = '910599352837009125203721943257004505993528370091252037219432570372268594215374344448178557927330505659829548196001541910397044574503804349888018481637021558820201495180652853839389373736354855089915654973646390593825402963369085598243175499331073210996369094524584737045812083227000057867534282991348704391352741963150846904684740081827853667405049291950563131087880761067102663540026285677395840413088174715082923530727315147001628040210198449287076046431564773892455551663145805008468300855353569160670769107273734038564797672775330380086322494841998600095197724618324340015371990124082923120036387971884629120210018406941724331997393028520399574577331410576856213987051688696744981047884734763621690605729499908487228784147873046418572825090779840794201637455940120941399814886616382625317460565896684910105909504707053360780917358988981169951477861282629772514247925341760072523828218731362450851436561547397656679975389798488887044194917116583673849515191323195914776662418177189603969638270971498700371796973381598884749348990545341638774881936625120806067766409748553292974329171798703826943631238764095392265996716384324391039958314190118742197999180964544894121268375540809742303181386694824266665061651735305169041165995833012997227'


@pytest.fixture()
def commitment_db(parametrised_storage) -> CommitmentDb:
    db = CommitmentDb(parametrised_storage)
    return db


def test_size_without_commitments(commitment_db):
    assert commitment_db.size == 0


def test_add_commitments(commitment_db):
    commitment_db.add_commitment(comm1)
    assert commitment_db.kv_store.get(commitment_db.commitment_key(comm1)).decode() == '1'
    assert commitment_db.kv_store.get(commitment_db.index_key(1)).decode() == comm1
    assert commitment_db.size == 1

    commitment_db.add_commitment(comm2)
    assert commitment_db.kv_store.get(commitment_db.commitment_key(comm2)).decode() == '2'
    assert commitment_db.kv_store.get(
        commitment_db.index_key(2)).decode() == comm2
    assert commitment_db.size == 2


def test_check_commitment_presence(commitment_db):
    commitment_db.add_commitment(comm1)
    assert commitment_db.has_commitment(comm1)
    assert not commitment_db.has_commitment(comm1+'21')


def test_get_commitment_index(commitment_db):
    commitment_db.add_commitment(comm1)
    commitment_db.add_commitment(comm2)
    assert commitment_db.get_commitment_index(comm1) == 1
    assert commitment_db.get_commitment_index(comm2) == 2
    with pytest.raises(KeyError):
        commitment_db.get_commitment_index(comm1+'44')


def test_get_commitment_from_index(commitment_db):
    comms = [comm1, comm2, comm3, comm4, comm5, comm6, comm7, comm8]
    for c in comms:
        commitment_db.add_commitment(c)
    assert commitment_db.all_commitments_from_index(2) == comms[1:]
    assert commitment_db.all_commitments_from_index(1) == comms
    assert commitment_db.all_commitments_from_index(3) == comms[2:]
    assert commitment_db.all_commitments_from_index(4) == comms[3:]
    assert commitment_db.all_commitments_from_index(5) == comms[4:]
    assert commitment_db.all_commitments_from_index(6) == comms[5:]
    assert commitment_db.all_commitments_from_index(7) == comms[6:]
    assert commitment_db.all_commitments_from_index(8) == comms[7:]
    assert commitment_db.all_commitments_from_index(9) == []
